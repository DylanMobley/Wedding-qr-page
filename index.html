<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dylan & Marianne Mobley's Honeymoon Fund</title>
  <style>
    :root{
      --pink:#e75480;
      --bg1:#ffe5b4;
      --bg2:#ffecd2;
      --ink:#333;
      --card:#fff7ef;
      --accent:#3a8f5b;
      --inkmuted:#5d5d5d;
    }
    body{
      background: linear-gradient(to bottom right, var(--bg1), var(--bg2));
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      text-align:center;
      padding:2rem 1rem 3rem;
      color:var(--ink);
    }
    h1{ color:var(--pink); margin-bottom:.5rem; }
    p{ font-size:1.1rem; line-height:1.6; margin:.5rem auto; max-width:44rem; }
    a.button{
      display:inline-block; margin-top:1rem; padding:.9rem 1.5rem;
      font-size:1.1rem; color:#fff; background:var(--pink); border-radius:8px;
      text-decoration:none; font-weight:700; transition:filter .2s ease;
      box-shadow:0 6px 16px rgba(231,84,128,.25);
    }
    a.button:hover{ filter:brightness(.95); }
    .game-card{
      margin:2.25rem auto 0; max-width:44rem; background:var(--card);
      border:2px solid rgba(0,0,0,.06); border-radius:14px; padding:1rem 1rem 1.25rem;
      box-shadow:0 8px 24px rgba(0,0,0,.06);
    }
    .flex-row{ display:flex; justify-content:center; align-items:center; gap:.5rem; flex-wrap:wrap; }
    .game-head{ font-weight:700; margin:.25rem 0 .25rem; color:#6b4423; }
    .game-sub{ font-size:.95rem; color:var(--inkmuted); margin:.25rem 0 .25rem; }
    .hud{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:.95rem; margin:.5rem 0 .5rem; color:#444; }
    .frame{
      width:min(92vw, 560px); aspect-ratio:16/9; margin:.5rem auto 0;
      image-rendering: pixelated; image-rendering: crisp-edges;
      border:6px solid #2b2420; border-radius:10px; background:#9fd8ff;
      box-shadow:inset 0 0 0 3px #fff; position:relative; overflow:hidden;
    }
    canvas{ width:100%; height:100%; display:block; }
    .controls{
      display:flex; align-items:center; justify-content:center; gap:.75rem; margin-top:.75rem;
      flex-wrap:wrap;
    }
    button.ctrl{
      background:#fff; border:2px solid #222; color:#222; border-radius:10px;
      padding:.5rem .8rem; font-weight:700; min-width:3rem;
      box-shadow:0 4px 0 #222; transform:translateY(0); transition:transform .05s;
      touch-action:manipulation; cursor:pointer;
    }
    button.ctrl:active{ transform:translateY(2px); box-shadow:0 2px 0 #222; }
    .dpad{
      display:grid; grid-template-columns:repeat(3,42px); grid-template-rows:repeat(3,42px);
      gap:6px; margin:.25rem .5rem 0;
    }
    .dpad .sp{ visibility:hidden }
    .pill{ background:var(--accent); color:#fff; padding:.25rem .5rem; border-radius:999px; font-size:.8rem; }
    .mute{ background:#ffdfe9; border:2px solid #e09; color:#c0175b; }
    .sel{
      background:#fff; border:1px solid #ccc; border-radius:8px; padding:.25rem .5rem;
      font-size:.9rem; cursor:pointer;
    }
    .leaderboard{
      margin-top:1rem; text-align:left; max-width:44rem; margin-left:auto; margin-right:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.95rem;
      color:#333; background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:10px; padding:.75rem 1rem;
    }
    .leaderboard h3{ margin:.25rem 0 .5rem; color:#6b4423; font-size:1rem; }
    .lb-row{ display:flex; justify-content:space-between; padding:.25rem 0; border-bottom:1px dashed rgba(0,0,0,.08); }
    .lb-row:last-child{ border-bottom:none; }
    .overlay{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.55); color:#fff; text-align:center; padding:1rem;
    }
    .overlay.show{ display:flex; }
    .overlay .panel{
      background:rgba(255,255,255,.9); color:#222; padding:1rem 1.25rem; border-radius:12px;
      max-width:90%; box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .panel h3{ margin:.25rem 0; color:#5b2a16; }
    .panel p{ margin:.25rem 0 .75rem; font-size:.95rem; }
    .panel input{ padding:.5rem .6rem; border:1px solid #bbb; border-radius:8px; width:160px; text-align:center; }
    .panel .row{ display:flex; gap:.5rem; justify-content:center; align-items:center; flex-wrap:wrap; }
    .panel .cta{
      background:var(--pink); color:#fff; border:none; padding:.6rem 1rem; border-radius:8px; font-weight:700; cursor:pointer;
    }
    .dim { opacity:.45; filter:grayscale(.5); }
  </style>
</head>
<body>
  <h1>‚ú® Please Join Us in Celebrating Our Next Chapter ‚ú®</h1>
  <p>We‚Äôre so grateful for your love and support as we begin our life together. Instead of a traditional registry, we‚Äôve created a Honeymoon Fund to help us make lasting memories.</p>
  <p>If you‚Äôd like to contribute, please visit:</p>
  <a href="https://tinyurl.com/DylanMarianneRSVP" target="_blank" class="button" aria-label="Contribute to our Honeymoon Fund via TinyURL">
    üëâ Contribute to Our Honeymoon Fund
  </a>

  <!-- Legendary 8-bit game with Players + Difficulty -->
  <section class="game-card" aria-labelledby="gameTitle">
    <div class="flex-row" style="justify-content:space-between; max-width:44rem; margin:0 auto;">
      <div class="pill">Bonus: Tiny 8-bit Game</div>
      <div class="flex-row">
        <label for="players">Players:</label>
        <select id="players" class="sel" title="Choose 1 or 2 players">
          <option value="1">1 Player</option>
          <option value="2" selected>2 Players</option>
        </select>
        <label for="difficulty">Difficulty:</label>
        <select id="difficulty" class="sel" title="Choose difficulty">
          <option value="1">‚≠ê Easy</option>
          <option value="2" selected>‚≠ê‚≠ê Normal</option>
          <option value="3">‚≠ê‚≠ê‚≠ê Hard</option>
        </select>
        <button class="ctrl mute" id="muteBtn" aria-pressed="false">üîà Sound On</button>
      </div>
    </div>
    <h2 id="gameTitle" class="game-head">Heart Quest ‚Äî Collect the Love! (1‚Äì2 Players)</h2>
    <p class="game-sub">
      P1: ‚óÄ ‚ñ≤ ‚ñº ‚ñ∂ &nbsp;|&nbsp; P2: W A S D &nbsp;|&nbsp; Collect hearts, <b>margaritas</b>, rings, champagne‚Äîavoid crabs.<br>
      Power-ups: <b>Golden Heart +5</b>, <b>Shield</b> (invincible), <b>Speed</b> (turbo). Space = Pause.
    </p>
    <div class="hud" id="hud">P1 Score: 0 | P2 Score: 0 | Time: 30s | Best: 0</div>

    <div class="frame">
      <canvas id="game" width="320" height="180" role="img" aria-label="Retro mini game: collect items before time runs out"></canvas>

      <!-- End overlay -->
      <div class="overlay" id="endOverlay">
        <div class="panel">
          <h3>Thanks for Activating Peace & Joy üíï</h3>
          <p id="finalScores">Final: P1 0 ‚Äî P2 0</p>
          <div class="row" style="margin-bottom:.5rem;">
            <input id="initials" maxlength="3" placeholder="Initials (ABC)" />
            <button class="cta" id="saveScore">Save to Leaderboard</button>
          </div>
          <div class="row">
            <a class="button" href="https://tinyurl.com/DylanMarianneRSVP" target="_blank">Contribute to Our Honeymoon Fund</a>
            <button class="ctrl" id="playAgain">Play Again</button>
          </div>
        </div>
      </div>
    </div>

    <!-- On-screen controls -->
    <div class="controls" aria-label="On-screen game controls">
      <div id="dpadP1" class="dpad" style="margin-right:.75rem">
        <button class="ctrl" data-k="ArrowUp">‚ñ≤</button>
        <button class="ctrl sp" tabindex="-1" aria-hidden="true"></button>
        <button class="ctrl" data-k="ArrowRight">‚ñ∂</button>
        <button class="ctrl" data-k="ArrowLeft">‚óÄ</button>
        <button class="ctrl" data-k="ArrowDown">‚ñº</button>
      </div>
      <div id="dpadP2" class="dpad">
        <button class="ctrl" data-k="KeyW">W</button>
        <button class="ctrl sp" tabindex="-1" aria-hidden="true"></button>
        <button class="ctrl" data-k="KeyD">D</button>
        <button class="ctrl" data-k="KeyA">A</button>
        <button class="ctrl" data-k="KeyS">S</button>
      </div>
      <div class="flex-row">
        <button class="ctrl" id="startBtn">Start</button>
        <button class="ctrl" id="pauseBtn">Pause</button>
      </div>
    </div>

    <!-- Leaderboard -->
    <div class="leaderboard" id="leaderboard">
      <h3>Hall of Fame</h3>
      <div id="lbRows"></div>
    </div>
  </section>

  <script>
    (() => {
      // ---------- DOM ----------
      const canvas = document.getElementById('game');
      const ctx = canvas.getContext('2d');
      const hud = document.getElementById('hud');
      const startBtn = document.getElementById('startBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const muteBtn = document.getElementById('muteBtn');
      const endOverlay = document.getElementById('endOverlay');
      const finalScores = document.getElementById('finalScores');
      const playAgain = document.getElementById('playAgain');
      const saveScoreBtn = document.getElementById('saveScore');
      const initialsInput = document.getElementById('initials');
      const lbRows = document.getElementById('lbRows');
      const diffSel = document.getElementById('difficulty');
      const playersSel = document.getElementById('players');
      const dpadP2 = document.getElementById('dpadP2');

      // ---------- Input ----------
      const keys = {};
      const press = (k,v)=>{ keys[k]=v; };

      // Block page scrolling while playing; allow typing in the initials input
      document.addEventListener('keydown', e => {
        const blockKeys = [
          'ArrowUp','ArrowDown','ArrowLeft','ArrowRight',
          'Space','KeyW','KeyA','KeyS','KeyD'
        ];
        const isTyping = (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA'));
        if (blockKeys.includes(e.code) && !isTyping) {
          e.preventDefault();
        }
        keys[e.code] = true;
      });
      document.addEventListener('keyup', e => { keys[e.code] = false; });

      document.querySelectorAll('[data-k]').forEach(b=>{
        const k=b.dataset.k;
        b.addEventListener('pointerdown', ()=>press(k,true));
        b.addEventListener('pointerup',   ()=>press(k,false));
        b.addEventListener('pointerleave',()=>press(k,false));
      });

      const W = canvas.width, H = canvas.height;
      const RNG = (a,b)=> a + Math.random()*(b-a);
      const CLAMP = (v,min,max)=> Math.max(min, Math.min(max,v));

      // ---------- Audio ----------
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      const actx = new AudioCtx();
      let muted = false;
      function beep(freq=440, dur=0.07, type='square', vol=0.03){
        if(muted) return;
        const o = actx.createOscillator();
        const g = actx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.value = vol;
        o.connect(g); g.connect(actx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); }, dur*1000);
      }
      function sCollect(){ beep(880,0.05,'square',0.05); }
      function sPower(){ beep(660,0.12,'sawtooth',0.04); }
      function sHit(){ beep(180,0.09,'square',0.05); }

      muteBtn.addEventListener('click',()=>{
        muted = !muted;
        muteBtn.textContent = muted ? 'üîá Sound Off' : 'üîà Sound On';
        muteBtn.setAttribute('aria-pressed', muted ? 'true':'false');
      });

      // ---------- Global render scale for items ----------
      const ITEM_SCALE = 4; // bigger collectibles for legibility

      // ---------- Players & Difficulty ----------
      let players = +playersSel.value; // 1 or 2
      playersSel.addEventListener('change', ()=>{
        players = +playersSel.value;
        dpadP2.classList.toggle('dim', players===1);
        updateHud();
      });

      let difficulty = +diffSel.value;
      const diffCfg = {
        1: { // Easy
          CRAB_BASE:0.7, CRAB_RANGE:0.4, CRAB_RAMP:0.4, CRAB_FRAME_MULT:1.000,
          CRAB_MAX_VX:2.0, CRAB_DRAG:0.997,
          P_SPEED:1.8, POWER_DUR:7,
          TICK_SPAWN_COLLECT:0.75, TICK_SPAWN_CRAB:0.45, TICK_SPAWN_POWER:0.35
        },
        2: { // Normal
          CRAB_BASE:0.9, CRAB_RANGE:0.7, CRAB_RAMP:0.6, CRAB_FRAME_MULT:1.001,
          CRAB_MAX_VX:2.2, CRAB_DRAG:0.998,
          P_SPEED:1.6, POWER_DUR:6,
          TICK_SPAWN_COLLECT:0.65, TICK_SPAWN_CRAB:0.50, TICK_SPAWN_POWER:0.25
        },
        3: { // Hard
          CRAB_BASE:1.2, CRAB_RANGE:1.0, CRAB_RAMP:1.0, CRAB_FRAME_MULT:1.002,
          CRAB_MAX_VX:2.6, CRAB_DRAG:0.999,
          P_SPEED:1.5, POWER_DUR:5,
          TICK_SPAWN_COLLECT:0.55, TICK_SPAWN_CRAB:0.65, TICK_SPAWN_POWER:0.18
        }
      };
      let CRAB_BASE=1, CRAB_RANGE=1, CRAB_RAMP=1, CRAB_FRAME_MULT=1.001;
      let CRAB_MAX_VX=2.2, CRAB_DRAG=0.998;
      let P_SPEED=1.6, POWER_DUR=6;
      let TICK_SPAWN_COLLECT=0.65, TICK_SPAWN_CRAB=0.5, TICK_SPAWN_POWER=0.25;

      function applyDifficulty(){
        const cfg = diffCfg[difficulty];
        CRAB_BASE      = cfg.CRAB_BASE;
        CRAB_RANGE     = cfg.CRAB_RANGE;
        CRAB_RAMP      = cfg.CRAB_RAMP;
        CRAB_FRAME_MULT= cfg.CRAB_FRAME_MULT;
        CRAB_MAX_VX    = cfg.CRAB_MAX_VX;
        CRAB_DRAG      = cfg.CRAB_DRAG;
        P_SPEED        = cfg.P_SPEED;
        POWER_DUR      = cfg.POWER_DUR;
        TICK_SPAWN_COLLECT = cfg.TICK_SPAWN_COLLECT;
        TICK_SPAWN_CRAB    = cfg.TICK_SPAWN_CRAB;
        TICK_SPAWN_POWER   = cfg.TICK_SPAWN_POWER;
      }
      diffSel.addEventListener('change', ()=>{ difficulty = +diffSel.value; applyDifficulty(); updateHud(); });

      // ---------- State ----------
      const state = {
        running:false,
        over:false,
        time:30,
        tAccum:0,
        p1:{x:W*0.3,y:H*0.6,s:8,vx:0,vy:0,shield:0,turbo:0,score:0},
        p2:{x:W*0.7,y:H*0.6,s:8,vx:0,vy:0,shield:0,turbo:0,score:0},
        items:[],
        crabs:[],
        popups:[], // {x,y,text,t}
        best: +(localStorage.getItem('heartquest_best_total')||0),
        board: JSON.parse(localStorage.getItem('heartquest_leaderboard')||'[]')
      };

      // ---------- Spawning ----------
      function reset(){
        state.time = 30;
        state.tAccum = 0;
        state.over = false;
        state.p1.score = 0; state.p2.score = 0;
        state.p1.x=W*0.3; state.p1.y=H*0.6; state.p2.x=W*0.7; state.p2.y=H*0.6;
        state.p1.shield=0; state.p1.turbo=0; state.p2.shield=0; state.p2.turbo=0;
        state.items = [];
        state.crabs = [];
        state.popups = [];
        for(let i=0;i<8;i++) spawnCollectible();
        for(let i=0;i<4;i++) spawnCrab();
        for(let i=0;i<2;i++) spawnPowerUp();
        updateHud();
        renderLeaderboard();
      }

      function spawnCrab(){
        const side = Math.random()<0.5 ? 0 : W;
        const ramp = 1 + CRAB_RAMP * (state.time / 30);
        const baseV = (CRAB_BASE + Math.random()*CRAB_RANGE) * ramp * 0.85; // gentler entry
        state.crabs.push({
          x: side,
          y: RNG(28,H-40),
          s: 8,
          vx: side===0 ? baseV : -baseV
        });
      }

      // Collectibles: heart(+1), champagne(+2), margarita(+3), ring(rare +7)
      function spawnCollectible(){
        const roll = Math.random();
        let type='heart', value=1;
        if(roll>0.85 && roll<=0.95){ type='margarita'; value=3; }
        else if(roll>0.95){ type='ring'; value=7; }
        else if(roll>0.65){ type='champagne'; value=2; }
        state.items.push({ kind:'collect', type, val:value, x:RNG(10,W-10), y:RNG(20,H-40) });
      }

      // Power-ups: goldheart(+5), shield, speed
      function spawnPowerUp(){
        const roll = Math.random();
        let type = 'goldheart';
        if(roll>0.75 && roll<=0.9) type='shield';
        else if(roll>0.9) type='speed';
        state.items.push({ kind:'power', type, val:(type==='goldheart'?5:0), x:RNG(10,W-10), y:RNG(20,H-40) });
      }

      // ---------- Drawing helpers ----------
      function pixelHeart(cx, cy, scale = ITEM_SCALE, color = '#ff1f64', outline = '#2a0f1a'){
        const px = [[0,1],[1,0],[2,0],[3,1],[0,2],[1,3],[2,3],[3,2],[1,2],[2,2]];
        if(outline){
          ctx.fillStyle = outline;
          px.forEach(([x,y])=>{
            ctx.fillRect(Math.floor(cx + (x-1.5)*scale)-1, Math.floor(cy + (y-1.5)*scale)-1, scale+2, scale+2);
          });
        }
        ctx.fillStyle = color;
        px.forEach(([x,y])=>{
          ctx.fillRect(Math.floor(cx + (x-1.5)*scale), Math.floor(cy + (y-1.5)*scale), scale, scale);
        });
      }

      function pixelItem(kind, x, y){
        const s = ITEM_SCALE;
        if(kind==='heart'){
          pixelHeart(x, y, s, '#ff1f64', '#2a0f1a');
          pixelHeart(x, y-1, s, '#ff7099', null); // highlight
        }
        else if(kind==='champagne'){
          ctx.fillStyle='#21321f'; ctx.fillRect(x-2*s-1, y-6*s-1, 4*s+2, 8*s+2); // outline
          ctx.fillStyle='#2f8a3b'; ctx.fillRect(x-2*s, y-6*s, 4*s, 8*s);         // bottle
          ctx.fillStyle='#d4a73b'; ctx.fillRect(x-1*s, y-8*s, 2*s, 2*s);         // cork
        }
        else if(kind==='margarita'){
          // outline
          ctx.fillStyle='#2b2b2b';
          ctx.fillRect(x-3*s-1, y-1-1, 6*s+2, 1+2);
          ctx.fillRect(x-2*s-1, y-3*s-1, 4*s+2, 3*s+2);
          ctx.fillRect(x-1*s-1, y+1-1, 2*s+2, 3*s+2);
          ctx.fillRect(x-2*s-1, y+4-1, 4*s+2, 1+2);
          ctx.fillRect(x+3*s-1, y-3*s-1, 2*s+2, 2*s+2);
          // fill
          ctx.fillStyle='#e0e0e0'; ctx.fillRect(x-3*s, y-1, 6*s, 1);     // rim
          ctx.fillStyle='#b2f7c2'; ctx.fillRect(x-2*s, y-3*s, 4*s, 3*s); // drink
          ctx.fillStyle='#e0e0e0'; ctx.fillRect(x-1*s, y+1, 2*s, 3*s);   // stem
          ctx.fillStyle='#e0e0e0'; ctx.fillRect(x-2*s, y+4, 4*s, 1);     // base
          ctx.fillStyle='#8ad64b'; ctx.fillRect(x+3*s, y-3*s, 2*s, 2*s); // lime
        }
        else if(kind==='ring'){
          ctx.fillStyle='#735a00'; ctx.fillRect(x-3*s-1, y-3*s-1, 6*s+2, 6*s+2); // outline
          ctx.fillStyle='#ffd700'; ctx.fillRect(x-3*s, y-3*s, 6*s, 6*s);         // ring
          ctx.clearRect(x-1*s, y-1*s, 2*s, 2*s);                                 // hole
          ctx.fillStyle='#9ad3ff'; ctx.fillRect(x-1*s, y-6, 2*s, 2*s);           // gem
        }
        else if(kind==='goldheart'){
          pixelHeart(x, y, s, '#ffdf4d', '#6a5400');
        }
        else if(kind==='shield'){
          ctx.strokeStyle='#46c2ff'; ctx.lineWidth=2; ctx.strokeRect(x-4*s, y-4*s, 8*s, 8*s);
        }
        else if(kind==='speed'){
          ctx.fillStyle='#2b1b47'; ctx.fillRect(x-3*s-1, y-2*s-1, 6*s+2, 4*s+2); // outline
          ctx.fillStyle='#9a4dff'; ctx.fillRect(x-3*s, y-2*s, 6*s, 4*s);         // bolt
          ctx.fillRect(x-5, y-1*s, 2, 2); ctx.fillRect(x+3*s, y-1*s, 2, 2);
        }
      }

      function drawBackground(){
        const total = state.p1.score + (players===2 ? state.p2.score : 0);
        const phase = total>=20 ? 'night' : total>=10 ? 'sunset' : 'day';
        if(phase==='day'){
          ctx.fillStyle = '#9fd8ff'; ctx.fillRect(0,0,W,H);
          ctx.fillStyle = '#5cc1ff'; ctx.fillRect(0,H*0.55,W,H*0.25);
          ctx.fillStyle = '#44a9e9'; ctx.fillRect(0,H*0.60,W,H*0.08);
        } else if(phase==='sunset'){
          const g = ctx.createLinearGradient(0,0,0,H);
          g.addColorStop(0,'#ffb169'); g.addColorStop(1,'#ffd59a');
          ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
          ctx.fillStyle = '#fe9a5c'; ctx.fillRect(0,H*0.55,W,H*0.25);
          ctx.fillStyle = '#e86f42'; ctx.fillRect(0,H*0.60,W,H*0.08);
        } else {
          ctx.fillStyle = '#0a1c3a'; ctx.fillRect(0,0,W,H);
          ctx.fillStyle = '#fff';
          for(let i=0;i<30;i++){ ctx.fillRect((i*11)%W, (i*7)%Math.floor(H*0.5), 1, 1); }
          ctx.fillStyle = '#0f3a5f'; ctx.fillRect(0,H*0.55,W,H*0.25);
          ctx.fillStyle = '#0c2c49'; ctx.fillRect(0,H*0.60,W,H*0.08);
        }
        ctx.fillStyle = '#ffd59a'; ctx.fillRect(0,H*0.75,W,H*0.25);
      }

      function drawPlayer(p, color){
        ctx.fillStyle = color;
        ctx.fillRect(p.x-6,p.y-6,12,12); // slightly larger
        ctx.fillStyle = '#fff'; ctx.fillRect(p.x-3,p.y-1,2,2);
        ctx.fillStyle = '#000'; ctx.fillRect(p.x-2,p.y,1,1);
        if(p.shield>0){
          ctx.strokeStyle = '#46c2ff';
          ctx.lineWidth = 1;
          ctx.strokeRect(p.x-8,p.y-8,16,16); // larger shield box
        }
      }

      function drawCrabs(){
        state.crabs.forEach(c=>{
          ctx.fillStyle = '#b33b3b';
          ctx.fillRect(c.x-7,c.y-3,14,6); // wider body
          ctx.fillStyle = '#fff'; ctx.fillRect(c.x-5,c.y-5,2,2); ctx.fillRect(c.x+3,c.y-5,2,2);
          ctx.fillStyle = '#000'; ctx.fillRect(c.x-4,c.y-4,1,1); ctx.fillRect(c.x+4,c.y-4,1,1);
          ctx.fillStyle = '#8d2a2a'; ctx.fillRect(c.x-8,c.y+2,3,1); ctx.fillRect(c.x+5,c.y+2,3,1);
        });
      }

      // ---------- Logic ----------
      function updatePlayers(dt){
        const p1 = state.p1, p2 = state.p2;
        const p1Speed = (p1.turbo>0 ? P_SPEED*1.8 : P_SPEED);
        const p2Speed = (p2.turbo>0 ? P_SPEED*1.8 : P_SPEED);

        // P1 arrows
        p1.vx = (keys['ArrowRight']?1:0) - (keys['ArrowLeft']?1:0);
        p1.vy = (keys['ArrowDown']?1:0) - (keys['ArrowUp']?1:0);
        p1.x = CLAMP(p1.x + p1.vx*p1Speed*dt*60, 6, W-6);
        p1.y = CLAMP(p1.y + p1.vy*p1Speed*dt*60, 12, H-12);

        if(players===2){
          // P2 WASD
          p2.vx = (keys['KeyD']?1:0) - (keys['KeyA']?1:0);
          p2.vy = (keys['KeyS']?1:0) - (keys['KeyW']?1:0);
          p2.x = CLAMP(p2.x + p2.vx*p2Speed*dt*60, 6, W-6);
          p2.y = CLAMP(p2.y + p2.vy*p2Speed*dt*60, 12, H-12);
        }

        if(p1.shield>0) p1.shield -= dt;
        if(p1.turbo>0)  p1.turbo  -= dt;
        if(p2.shield>0) p2.shield -= dt;
        if(p2.turbo>0)  p2.turbo  -= dt;
      }

      function handleCollectibles(){
        const playersArr = players===2 ? [state.p1,state.p2] : [state.p1];
        state.items = state.items.filter(it=>{
          let taken=false;
          for(const p of playersArr){
            const d = Math.hypot(it.x-p.x, it.y-p.y);
            if(d<11){
              if(it.kind==='collect'){
                const add = it.val|0;
                if(p===state.p1) state.p1.score += add; else state.p2.score += add;
                // popup
                state.popups.push({ x:p.x, y:p.y-8, text:`+${add}`, t:0 });
                sCollect();
                if(Math.random()<0.7) spawnCollectible();
              } else {
                if(it.type==='goldheart'){
                  if(p===state.p1) state.p1.score += 5; else state.p2.score += 5;
                  state.popups.push({ x:p.x, y:p.y-8, text:'+5', t:0 });
                } else if(it.type==='shield'){
                  p.shield = POWER_DUR;
                  state.popups.push({ x:p.x, y:p.y-8, text:'SHIELD', t:0 });
                } else if(it.type==='speed'){
                  p.turbo = POWER_DUR;
                  state.popups.push({ x:p.x, y:p.y-8, text:'SPEED', t:0 });
                }
                sPower();
                if(Math.random()<0.5) spawnPowerUp();
              }
              taken=true; break;
            }
          }
          return !taken;
        });
      }

      function handleCrabs(dt){
        const playersArr = players===2 ? [state.p1,state.p2] : [state.p1];
        state.crabs.forEach(c=>{
          // move
          c.x += c.vx*dt*60;

          // bounce with clamps
          if(c.x < 12){ c.x = 12; c.vx = Math.abs(c.vx); }
          if(c.x > W-12){ c.x = W-12; c.vx = -Math.abs(c.vx); }

          // growth + drag + speed cap
          c.vx *= CRAB_FRAME_MULT;
          c.vx *= CRAB_DRAG;
          const sign = Math.sign(c.vx) || 1;
          c.vx = sign * Math.min(Math.abs(c.vx), CRAB_MAX_VX);

          // collisions
          playersArr.forEach(p=>{
            const d = Math.hypot(c.x-p.x, c.y-p.y);
            if(d<12 && p.shield<=0){
              if(p===state.p1) state.p1.score = Math.max(0, state.p1.score-1);
              else state.p2.score = Math.max(0, state.p2.score-1);
              state.popups.push({ x:p.x, y:p.y-8, text:'-1', t:0 });
              sHit();
            }
          });
        });
      }

      function updateTimer(dt){
        state.tAccum += dt;
        if(state.running && state.tAccum>=1){
          state.time -= 1; state.tAccum = 0;
          if(Math.random()<TICK_SPAWN_COLLECT) spawnCollectible();
          if(Math.random()<TICK_SPAWN_CRAB) spawnCrab();
          if(Math.random()<TICK_SPAWN_POWER) spawnPowerUp();
          if(state.time<=0){ endGame(); }
          updateHud();
        }
      }

      function updateHud(){
        if(players===2){
          hud.textContent = `P1 Score: ${state.p1.score} | P2 Score: ${state.p2.score} | Time: ${state.time}s | Best: ${state.best} | ${['‚≠ê Easy','‚≠ê‚≠ê Normal','‚≠ê‚≠ê‚≠ê Hard'][difficulty-1]}`;
        } else {
          hud.textContent = `Score: ${state.p1.score} | Time: ${state.time}s | Best: ${state.best} | ${['‚≠ê Easy','‚≠ê‚≠ê Normal','‚≠ê‚≠ê‚≠ê Hard'][difficulty-1]}`;
        }
      }

      // ---------- Loop ----------
      let last=performance.now();
      function loop(t){
        const dt = Math.min(0.033, (t-last)/1000); last=t;

        drawBackground();
        state.items.forEach(it=> pixelItem(it.type, it.x, it.y));
        drawCrabs();
        drawPlayer(state.p1,'#ff6fa5');
        if(players===2) drawPlayer(state.p2,'#4aa3ff');

        // popups (fade & rise)
        state.popups = state.popups.filter(pp => {
          pp.t += 0.02;
          const alpha = Math.max(0, 1 - pp.t);
          const yy = pp.y - pp.t*12;
          ctx.globalAlpha = 0.6*alpha;
          ctx.fillStyle = '#000';
          const w = Math.max(26, ctx.measureText(pp.text).width+6);
          ctx.fillRect(pp.x-8, yy-10, w, 12);
          ctx.globalAlpha = alpha;
          ctx.fillStyle = '#fff';
          ctx.font = '10px monospace';
          ctx.fillText(pp.text, pp.x-6, yy);
          ctx.globalAlpha = 1;
          return pp.t < 1.2;
        });

        if(state.running){
          updatePlayers(dt);
          handleCollectibles();
          handleCrabs(dt);
          updateTimer(dt);
        }
        requestAnimationFrame(loop);
      }

      // ---------- End / Leaderboard ----------
      function endGame(){
        state.running=false; state.over=true;
        const total = state.p1.score + (players===2 ? state.p2.score : 0);
        if(total > state.best){
          state.best = total;
          localStorage.setItem('heartquest_best_total', total);
        }
        finalScores.textContent = players===2
          ? `Final ‚Äî P1: ${state.p1.score} | P2: ${state.p2.score} | Total: ${total}`
          : `Final ‚Äî Score: ${state.p1.score}`;
        endOverlay.classList.add('show');
        initialsInput.focus();
        updateHud();
      }

      function renderLeaderboard(){
        const list = (state.board||[]).slice(0,5);
        lbRows.innerHTML = list.length
          ? list.map((r,i)=>`<div class="lb-row"><span>#${i+1} ${r.i}</span><span>${r.s}</span></div>`).join('')
          : `<div class="lb-row"><span>No scores yet ‚Äî be the first!</span><span>‚Äî</span></div>`;
      }

      function saveLeaderboard(){
        const initials = (initialsInput.value || '').toUpperCase().replace(/[^A-Z]/g,'').slice(0,3) || 'GUEST';
        const total = state.p1.score + (players===2 ? state.p2.score : 0);
        const entry = { i: initials, s: total, t: Date.now() };
        const board = (state.board||[]);
        board.push(entry);
        board.sort((a,b)=> b.s - a.s || a.t - b.t);
        state.board = board.slice(0,5);
        localStorage.setItem('heartquest_leaderboard', JSON.stringify(state.board));
        renderLeaderboard();
      }

      // ---------- Controls ----------
      function start(){
        applyDifficulty();
        reset();
        state.running = true;
        endOverlay.classList.remove('show');
        updateHud();
      }
      function pause(){ state.running = !state.running; pauseBtn.textContent = state.running ? 'Pause' : 'Resume'; }

      startBtn.addEventListener('click', start);
      pauseBtn.addEventListener('click', pause);
      playAgain.addEventListener('click', start);
      saveScoreBtn.addEventListener('click', ()=>{ saveLeaderboard(); initialsInput.value=''; });

      // Space toggles pause (but not when typing in initials)
      document.addEventListener('keydown', e=>{
        const isTyping = (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA'));
        if(e.code === 'Space' && !isTyping){ e.preventDefault(); pause(); }
      });

      // Boot
      dpadP2.classList.toggle('dim', +playersSel.value===1);
      applyDifficulty();
      reset(); requestAnimationFrame(loop);

      // Activate audio on first gesture
      ['click','touchstart','keydown'].forEach(evt=>{
        window.addEventListener(evt, ()=>{ if(actx.state==='suspended') actx.resume(); }, {once:true});
      });
    })();
  </script>

  <!-- Primary CTA again below game for convenience -->
  <div style="margin-top:1.25rem">
    <a href="https://tinyurl.com/DylanMarianneRSVP" target="_blank" class="button">
      üíñ Contribute to Our Honeymoon Fund
    </a>
  </div>
</body>
</html>
