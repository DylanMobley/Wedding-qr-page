<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Dylan & Marianne Mobley's Honeymoon Fund</title>
  <style>
    :root{
      --pink:#e75480; --bg1:#ffe5b4; --bg2:#ffecd2; --ink:#333;
      --card:#fff7ef; --accent:#3a8f5b; --inkmuted:#5d5d5d;
      --joyBase: rgba(0,0,0,.25); --joyKnob:#fff; --joyRing: rgba(255,255,255,.6);
      --fs-base: clamp(14px, 2.6vw, 18px);
      --fs-small: clamp(12px, 2.2vw, 16px);
      --fs-h1: clamp(22px, 6vw, 34px);
      --fs-h2: clamp(16px, 4.6vw, 22px);
      --fs-hud: clamp(12px, 2.6vw, 16px);
      --fs-button: clamp(14px, 2.8vw, 18px);
      --pad: clamp(10px, 3vw, 18px); --radius: 14px;
      --joyBaseSize: 100px; --joyKnobSize: 56px; --joyPadInset: 12px;
      --frame-max: 560px;
    }
    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important}}
    body{
      background:linear-gradient(to bottom right,var(--bg1),var(--bg2));
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      text-align:center; padding:calc(var(--pad) + env(safe-area-inset-top)) var(--pad) calc(var(--pad) + env(safe-area-inset-bottom));
      color:var(--ink); margin:0; font-size:var(--fs-base); -webkit-tap-highlight-color:transparent;
    }
    h1{color:var(--pink);margin:.25rem 0 .75rem;font-size:var(--fs-h1);line-height:1.2}
    h2{font-size:var(--fs-h2)}
    p{line-height:1.6;margin:.5rem auto;max-width:44rem}
    a.button{
      display:inline-block;margin-top:.75rem;padding:.9rem 1.25rem;font-size:var(--fs-button);
      color:#fff;background:var(--pink);border-radius:10px;text-decoration:none;font-weight:700;
      transition:filter .2s ease;box-shadow:0 6px 16px rgba(231,84,128,.25);min-height:44px
    }
    a.button:hover{filter:brightness(.95)}
    .game-card{margin:1.75rem auto 0;max-width:44rem;background:var(--card);border:2px solid rgba(0,0,0,.06);border-radius:var(--radius);padding:var(--pad);box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .flex-row{display:flex;justify-content:center;align-items:center;gap:.5rem;flex-wrap:wrap}
    .game-head{font-weight:700;margin:.35rem 0 .25rem;color:#6b4423}
    .game-sub{font-size:var(--fs-small);color:#6b4423;margin:.25rem 0 .35rem}
    .hud{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:var(--fs-hud);margin:.45rem 0;color:#444}
    .frame{
      width:min(96vw,var(--frame-max)); margin:.5rem auto 0; image-rendering:pixelated; image-rendering:crisp-edges;
      border:6px solid #2b2420;border-radius:10px;background:#9fd8ff;box-shadow:inset 0 0 0 3px #fff;position:relative;overflow:hidden;touch-action:none
    }
    canvas{width:100%;height:auto;display:block}
    .controls{display:flex;align-items:center;justify-content:center;gap:.5rem;margin-top:.6rem;flex-wrap:wrap}
    button.ctrl{
      background:#fff;border:2px solid #222;color:#222;border-radius:10px;padding:.55rem .85rem;font-weight:700;min-width:3rem;min-height:44px;
      box-shadow:0 4px 0 #222;transform:translateY(0);transition:transform .05s;touch-action:manipulation;cursor:pointer;font-size:var(--fs-button)
    }
    button.ctrl:active{transform:translateY(2px);box-shadow:0 2px 0 #222}
    .dpad{display:grid;grid-template-columns:repeat(3,42px);grid-template-rows:repeat(3,42px);gap:6px;margin:.25rem .5rem 0}
    .dpad .sp{visibility:hidden}
    @media (max-width:768px){.dpad{display:none!important}}
    .pill{background:var(--accent);color:#fff;padding:.25rem .6rem;border-radius:999px;font-size:var(--fs-small)}
    .mute{background:#ffdfe9;border:2px solid #e09;color:#c0175b}
    .sel{background:#fff;border:1px solid #ccc;border-radius:8px;padding:.35rem .6rem;font-size:var(--fs-small);min-height:40px}
    .leaderboard{margin-top:.85rem;text-align:left;max-width:44rem;margin-left:auto;margin-right:auto;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:var(--fs-small);color:#333;background:#fff;border:1px solid rgba(0,0,0,.08);border-radius:10px;padding:.75rem 1rem}
    .leaderboard h3{margin:.25rem 0 .5rem;color:#6b4423;font-size:clamp(14px,3.4vw,18px)}
    .lb-row{display:flex;justify-content:space-between;padding:.25rem 0;border-bottom:1px dashed rgba(0,0,0,.08)}
    .lb-row:last-child{border-bottom:none}
    .overlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);color:#fff;text-align:center;padding:1rem;z-index:5}
    .overlay.show{display:flex}
    .overlay .panel{background:rgba(255,255,255,.96);color:#222;padding:1rem 1.25rem;border-radius:12px;max-width:min(94vw,520px);box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .panel h3{margin:.25rem 0;color:#5b2a16;font-size:clamp(18px,5.2vw,22px)}
    .panel p{margin:.25rem 0 .75rem;font-size:var(--fs-small)}
    .panel ul{margin:.25rem 0 .75rem;padding-left:1.2rem;text-align:left;font-size:var(--fs-small)}
    .panel li{margin:.25rem 0}
    .panel input{padding:.6rem .7rem;border:1px solid #bbb;border-radius:8px;width:min(70%,220px);text-align:center;font-size:var(--fs-base);min-height:44px}
    .panel .row{display:flex;gap:.5rem;justify-content:center;align-items:center;flex-wrap:wrap}
    .panel .cta{background:var(--pink);color:#fff;border:none;padding:.75rem 1.1rem;border-radius:10px;font-weight:800;cursor:pointer;box-shadow:0 6px 16px rgba(231,84,128,.3);min-height:44px;font-size:var(--fs-button)}
    .touchpad{position:absolute;top:0;height:100%;width:50%;background:transparent;touch-action:none;pointer-events:auto;user-select:none;z-index:1}
    .touchpad.disabled{pointer-events:none;opacity:.6}
    #touchP1{left:0} #touchP2{right:0}
    .joyBase{position:absolute;width:var(--joyBaseSize);height:var(--joyBaseSize);border-radius:50%;background:var(--joyBase);border:2px solid var(--joyRing);bottom:var(--joyPadInset);opacity:.7}
    .joyKnob{position:absolute;width:var(--joyKnobSize);height:var(--joyKnobSize);border-radius:50%;background:var(--joyKnob);border:3px solid var(--joyRing);box-shadow:0 6px 16px rgba(0,0,0,.25);transform:translate(-50%,-50%);opacity:.9}
    #touchP1 .joyBase{left:var(--joyPadInset)} #touchP2 .joyBase{right:var(--joyPadInset)}
    .padLabel{position:absolute;bottom:calc(var(--joyPadInset) + var(--joyBaseSize) + 8px);font-weight:800;font-size:var(--fs-small);color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.6);opacity:.9}
    #touchP1 .padLabel{left:calc(var(--joyPadInset) + 6px)} #touchP2 .padLabel{right:calc(var(--joyPadInset) + 6px)}
    @media (max-width:480px){:root{--joyBaseSize:88px;--joyKnobSize:50px;--joyPadInset:10px}}
    @media (max-width:380px){:root{--joyBaseSize:76px;--joyKnobSize:44px;--joyPadInset:8px}}
  </style>
</head>
<body>
  <h1>‚ú® Please Join Us in Celebrating Our Next Chapter ‚ú®</h1>
  <p>We‚Äôre so grateful for your love and support as we begin our life together. Instead of a traditional registry, we‚Äôve created a Honeymoon Fund to help us make lasting memories.</p>
  <p>If you‚Äôd like to contribute, please visit:</p>
  <a href="https://tinyurl.com/DylanMarianneRSVP" target="_blank" class="button" aria-label="Contribute to our Honeymoon Fund via TinyURL">
    üëâ Contribute to Our Honeymoon Fund
  </a>

  <section class="game-card" aria-labelledby="gameTitle">
    <div class="flex-row" style="justify-content:space-between; max-width:44rem; margin:0 auto;">
      <div class="pill">Bonus: Tiny 8-bit Game</div>
      <div class="flex-row">
        <label for="players">Players:</label>
        <select id="players" class="sel" title="Choose 1 or 2 players">
          <option value="1">1 Player</option>
          <option value="2" selected>2 Players</option>
        </select>
        <label for="difficulty">Difficulty:</label>
        <select id="difficulty" class="sel" title="Choose difficulty">
          <option value="1">‚≠ê Easy</option>
          <option value="2" selected>‚≠ê‚≠ê Normal</option>
          <option value="3">‚≠ê‚≠ê‚≠ê Hard</option>
        </select>
        <button class="ctrl mute" id="muteBtn" aria-pressed="false" onclick="__toggleMute()">üîà Sound On</button>
      </div>
    </div>

    <h2 id="gameTitle" class="game-head">Heart Quest ‚Äî Collect the Love! (1‚Äì2 Players)</h2>
    <p class="game-sub">
      P1: ‚óÄ ‚ñ≤ ‚ñº ‚ñ∂ &nbsp;|&nbsp; P2: W A S D &nbsp;|&nbsp; Collect hearts, <b>margaritas</b>, rings, champagne‚Äîavoid crabs.
      Power-ups: <b>Golden Heart +5</b>, <b>Shield</b>, <b>Speed</b>, <b>Time +5s</b>. Space = Pause.
    </p>
    <div class="hud" id="hud">P1 Score: 0 | P2 Score: 0 | Time: 30s | Best: 0</div>

    <div class="frame" id="frame">
      <canvas id="game" width="320" height="180" role="img" aria-label="Retro mini game: collect items before time runs out"></canvas>

      <!-- START overlay -->
      <div class="overlay show" id="startOverlay" aria-modal="true">
        <div class="panel" role="dialog" aria-labelledby="howTitle">
          <h3 id="howTitle">How to Play üíñ</h3>
          <ul>
            <li><b>Player 1:</b> Arrow Keys (or left joystick)</li>
            <li><b>Player 2:</b> W A S D (or right joystick)</li>
            <li>Collect <b>Hearts</b>, <b>Margaritas</b>, <b>Rings</b>, <b>Champagne</b>; avoid <b>Crabs</b> (‚àí1 unless Shielded)</li>
            <li>Power-ups: <b>Golden Heart +5</b>, <b>Shield</b>, <b>Speed</b>, <b>Time +5s</b></li>
            <li><b>Space</b> = Pause/Resume</li>
          </ul>
          <div class="row" style="margin:.4rem 0 .6rem">
            <label for="playersStart">Players:</label>
            <select id="playersStart" class="sel">
              <option value="1">1 Player</option>
              <option value="2" selected>2 Players</option>
            </select>
            <label for="difficultyStart">Difficulty:</label>
            <select id="difficultyStart" class="sel">
              <option value="1">‚≠ê Easy</option>
              <option value="2" selected>‚≠ê‚≠ê Normal</option>
              <option value="3">‚≠ê‚≠ê‚≠ê Hard</option>
            </select>
          </div>
          <div class="row" style="margin-top:.25rem">
            <button class="cta" id="startOverlayBtn" onclick="__doStart()">‚ñ∂ Start Game</button>
          </div>
          <p style="margin:.5rem 0 0; font-size: var(--fs-small); color:#444;">Tip: Press <b>Space</b> or <b>Enter</b> to start.</p>
        </div>
      </div>

      <!-- END overlay -->
      <div class="overlay" id="endOverlay">
        <div class="panel">
          <h3>Thanks for Activating Peace & Joy üíï</h3>
          <p id="finalScores">Final: P1 0 ‚Äî P2 0</p>
          <div class="row" style="margin-bottom:.5rem;">
            <input id="initials" maxlength="3" placeholder="Initials (ABC)" />
            <button class="cta" id="saveScore">Save to Leaderboard</button>
          </div>
          <div class="row">
            <a class="button" href="https://tinyurl.com/DylanMarianneRSVP" target="_blank">Contribute to Our Honeymoon Fund</a>
            <button class="ctrl" id="playAgain" onclick="__doStart()">Play Again</button>
          </div>
        </div>
      </div>

      <!-- Two-thumb pads -->
      <div id="touchP1" class="touchpad disabled" aria-hidden="true">
        <div class="joyBase" id="joyBase1"></div>
        <div class="joyKnob" id="joyKnob1"></div>
        <div class="padLabel">P1</div>
      </div>
      <div id="touchP2" class="touchpad disabled" aria-hidden="true">
        <div class="joyBase" id="joyBase2"></div>
        <div class="joyKnob" id="joyKnob2"></div>
        <div class="padLabel">P2</div>
      </div>
    </div>

    <!-- Bottom controls -->
    <div class="controls" aria-label="On-screen game controls">
      <div id="dpadP1" class="dpad" style="margin-right:.5rem">
        <button class="ctrl" data-k="ArrowUp">‚ñ≤</button>
        <button class="ctrl sp" tabindex="-1" aria-hidden="true"></button>
        <button class="ctrl" data-k="ArrowRight">‚ñ∂</button>
        <button class="ctrl" data-k="ArrowLeft">‚óÄ</button>
        <button class="ctrl" data-k="ArrowDown">‚ñº</button>
      </div>
      <div id="dpadP2" class="dpad">
        <button class="ctrl" data-k="KeyW">W</button>
        <button class="ctrl sp" tabindex="-1" aria-hidden="true"></button>
        <button class="ctrl" data-k="KeyD">D</button>
        <button class="ctrl" data-k="KeyA">A</button>
        <button class="ctrl" data-k="KeyS">S</button>
      </div>
      <div class="flex-row">
        <button class="ctrl" id="startBtn">Start</button>
        <button class="ctrl" id="pauseBtn">Pause</button>
      </div>
    </div>

    <div class="leaderboard" id="leaderboard">
      <h3>Hall of Fame</h3>
      <div id="lbRows"></div>
    </div>
  </section>

  <script>
    window.addEventListener('error', e => console.log('üí•', e.message));

    (() => {
      const canvas = document.getElementById('game');
      const ctx = canvas.getContext('2d');
      const hud = document.getElementById('hud');
      const pauseBtn = document.getElementById('pauseBtn');
      const startOverlay = document.getElementById('startOverlay');
      const endOverlay = document.getElementById('endOverlay');
      const finalScores = document.getElementById('finalScores');
      const saveScoreBtn = document.getElementById('saveScore');
      const initialsInput = document.getElementById('initials');
      const lbRows = document.getElementById('lbRows');
      const diffSel = document.getElementById('difficulty');
      const playersSel = document.getElementById('players');
      const diffSelStart = document.getElementById('difficultyStart');
      const playersSelStart = document.getElementById('playersStart');
      const dpadButtons = document.querySelectorAll('[data-k]');
      const tp1 = document.getElementById('touchP1');
      const tp2 = document.getElementById('touchP2');
      const joyBase1 = document.getElementById('joyBase1');
      const joyKnob1 = document.getElementById('joyKnob1');
      const joyBase2 = document.getElementById('joyBase2');
      const joyKnob2 = document.getElementById('joyKnob2');

      const keys = {};
      const press = (k,v)=>{ keys[k]=v; };

      document.addEventListener('keydown', e => {
        const block=['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space','Enter','KeyW','KeyA','KeyS','KeyD'];
        const typing=/INPUT|TEXTAREA/.test(e.target.tagName);
        if(block.includes(e.code)&&!typing) e.preventDefault();
        if((e.code==='Space'||e.code==='Enter') && startOverlay.classList.contains('show') && !typing){ __doStart(); }
        keys[e.code]=true;
      }, {passive:false});
      document.addEventListener('keyup', e => { keys[e.code]=false; });
      dpadButtons.forEach(b=>{
        const k=b.dataset.k;
        b.addEventListener('pointerdown', ()=>press(k,true));
        b.addEventListener('pointerup',   ()=>press(k,false));
        b.addEventListener('pointerleave',()=>press(k,false));
      });

      let W=canvas.width, H=canvas.height;
      function setAspectForScreen(){
        const narrow=window.innerWidth<=380;
        const targetW=320, targetH=narrow?240:180;
        if(canvas.width!==targetW||canvas.height!==targetH){
          canvas.width=targetW; canvas.height=targetH; W=targetW; H=targetH; clampAllToBounds();
        }
      }

      // Audio
      let actx=null; try{const AC=window.AudioContext||window.webkitAudioContext; actx=new AC();}catch(e){}
      let muted=false;
      function beep(f=440,d=0.07,t='square',v=0.03){
        if(muted||!actx) return;
        const o=actx.createOscillator(), g=actx.createGain();
        o.type=t; o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(actx.destination); o.start();
        setTimeout(()=>{try{o.stop()}catch{}}, d*1000);
      }
      const sCollect=()=>beep(880,0.05,'square',0.05);
      const sPower =()=>beep(660,0.12,'sawtooth',0.04);
      const sHit   =()=>beep(180,0.09,'square',0.05);
      ['click','touchstart','pointerdown','keydown'].forEach(evt=>{
        window.addEventListener(evt,()=>{ if(actx && actx.state==='suspended') actx.resume(); },{once:true});
      });

      /* ================== DIFFICULTY ================== */
      const diffCfg = {
        1:{CRAB_BASE:0.7,CRAB_RANGE:0.4,CRAB_RAMP:0.4,CRAB_FRAME_MULT:1.000,CRAB_MAX_VX:2.0,CRAB_DRAG:0.997,P_SPEED:1.8,POWER_DUR:7,TICK_SPAWN_COLLECT:0.75,TICK_SPAWN_CRAB:0.45,TICK_SPAWN_POWER:0.35},
        2:{CRAB_BASE:0.9,CRAB_RANGE:0.7,CRAB_RAMP:0.6,CRAB_FRAME_MULT:1.001,CRAB_MAX_VX:2.2,CRAB_DRAG:0.998,P_SPEED:1.6,POWER_DUR:6,TICK_SPAWN_COLLECT:0.65,TICK_SPAWN_CRAB:0.50,TICK_SPAWN_POWER:0.25},
        3:{CRAB_BASE:1.2,CRAB_RANGE:1.0,CRAB_RAMP:1.0,CRAB_FRAME_MULT:1.002,CRAB_MAX_VX:2.6,CRAB_DRAG:0.999,P_SPEED:1.5,POWER_DUR:5,TICK_SPAWN_COLLECT:0.55,TICK_SPAWN_CRAB:0.65,TICK_SPAWN_POWER:0.18}
      };
      let players=+playersSel.value, difficulty=+diffSel.value;
      let CRAB_BASE=1,CRAB_RANGE=1,CRAB_RAMP=1,CRAB_FRAME_MULT=1.001,CRAB_MAX_VX=2.2,CRAB_DRAG=0.998;
      let P_SPEED=1.6,POWER_DUR=6,TICK_SPAWN_COLLECT=0.65,TICK_SPAWN_CRAB=0.5,TICK_SPAWN_POWER=0.25;

      function applyDifficulty(){
        const c=diffCfg[difficulty];
        CRAB_BASE=c.CRAB_BASE;CRAB_RANGE=c.CRAB_RANGE;CRAB_RAMP=c.CRAB_RAMP;CRAB_FRAME_MULT=c.CRAB_FRAME_MULT;
        CRAB_MAX_VX=c.CRAB_MAX_VX;CRAB_DRAG=c.CRAB_DRAG;P_SPEED=c.P_SPEED;POWER_DUR=c.POWER_DUR;
        TICK_SPAWN_COLLECT=c.TICK_SPAWN_COLLECT;TICK_SPAWN_CRAB=c.TICK_SPAWN_CRAB;TICK_SPAWN_POWER=c.TICK_SPAWN_POWER;
      }

      playersSel.addEventListener('change', ()=>{players=+playersSel.value; togglePads(); playersSelStart.value=playersSel.value;});
      diffSel.addEventListener('change', ()=>{difficulty=+diffSel.value; diffSelStart.value=diffSel.value; applyDifficulty();});
      playersSelStart.addEventListener('change', ()=>{playersSel.value=playersSelStart.value; players=+playersSel.value; togglePads();});
      diffSelStart.addEventListener('change', ()=>{diffSel.value=diffSelStart.value; difficulty=+diffSel.value; applyDifficulty();});

      const STORAGE_BEST='heartquest_best_total', STORAGE_LB='heartquest_leaderboard';

      /* ================== LEADERBOARD SANITIZER ================== */
      function safeLoadBoard(){
        try{
          const raw = JSON.parse(localStorage.getItem(STORAGE_LB) || '[]');
          const cleaned = (Array.isArray(raw)?raw:[])
            .filter(e=>e && typeof e==='object')
            .map(e=>({
              initials: (e.initials && String(e.initials).toUpperCase().slice(0,3)) || 'YOU',
              score: Number.isFinite(+e.score) ? +e.score : 0,
              ts: +e.ts || Date.now()
            }))
            .filter(e=>e.score>=0);
          localStorage.setItem(STORAGE_LB, JSON.stringify(cleaned));
          return cleaned;
        }catch{ return []; }
      }

      const state={
        running:false,over:false,time:30,tAccum:0, spawnTick:0,
        p1:{x:W*.3,y:H*.6,s:8,vx:0,vy:0,shield:0,turbo:0,score:0},
        p2:{x:W*.7,y:H*.6,s:8,vx:0,vy:0,shield:0,turbo:0,score:0},
        items:[],crabs:[],
        best: Math.max(0, +(localStorage.getItem(STORAGE_BEST)||0) || 0),
        board: safeLoadBoard()
      };

      const RNG=(a,b)=>a+Math.random()*(b-a);
      const CLAMP=(v,min,max)=>Math.max(min,Math.min(max,v));

      /* ================== SPRITE HELPERS + PIXEL MAPS ================== */
      const ITEM_SCALE = 4;
      const SPR = {};

      function drawSprite(x, y, sprite, scale=4){
        const px = sprite.px, pal = sprite.pal;
        const h = px.length, w = px[0].length;
        for(let row=0; row<h; row++){
          for(let col=0; col<w; col++){
            const c = px[row][col];
            if(c==='.') continue;
            ctx.fillStyle = pal[c] || '#000';
            ctx.fillRect(Math.round(x + col*scale), Math.round(y + row*scale), scale, scale);
          }
        }
      }
      function drawSpriteCentered(cx, cy, sprite, scale=4){
        const w = sprite.px[0].length * scale;
        const h = sprite.px.length * scale;
        drawSprite(cx - (w>>1), cy - (h>>1), sprite, scale);
      }

      SPR.heart = {
        pal: { r:'#ff5b8a', s:'#d13b67' },
        px: [
          '..rr..rr..',
          '.rrrrrrrr.',
          'rrrrrrrrrr',
          'rrrrrrrrrr',
          '.rrrrrrrr.',
          '..rrrrrr..',
          '...rrrr...',
          '....rr....',
          '.....s....'
        ]
      };
      SPR.heartGold = { pal: { r:'#ffd700', s:'#b59400' }, px: SPR.heart.px };

      SPR.ring = {
        pal: { g:'#ffd700', d:'#b59400' },
        px: [
          '..gggggg..',
          '.ggddddgg.',
          'ggd....dgg',
          'gd......dg',
          'gd......dg',
          'ggd....dgg',
          '.ggddddgg.',
          '..gggggg..'
        ]
      };

      SPR.champagne = {
        pal: { w:'#ffffff', b:'#87c66b', s:'#c0c0c0' },
        px: [
          '..wwww..',
          '.wwbbww.',
          '.wbbbbw.',
          '..wbbw..',
          '...ww...',
          '..ssss..',
          '...ss...',
          '..ssss..'
        ]
      };

      SPR.margarita = {
        pal: { g:'#58d68d', w:'#ffffff', s:'#c0c0c0' },
        px: [
          '.ggggggg.',
          'ggggggggg',
          '.ggggggg.',
          '..gwwwg..',
          '...gsg...',
          '..gsssg..',
          '...sss...',
          '..gsssg..'
        ]
      };

      SPR.crab = {
        pal: { r:'#c0392b', d:'#8e2b21', k:'#000' },
        px: [
          'r....rr....',
          '.r..rrrr..r',
          '..rrrrrrrr.',
          '..rrrrrrrr.',
          '.rrrrrrrrrr',
          'r.rrrkkrr.r',
          '...r..r....'
        ]
      };

      SPR.p1 = { pal: { a:'#ff4d6d', k:'#000' }, px: [
        '.aaaa.',
        'aaaaaa',
        'aaaaaa',
        '.aaaa.',
        '..aa..'
      ]};
      SPR.p2 = { pal: { a:'#4d7dff', k:'#000' }, px: SPR.p1.px };

      /* ================== CORE GAME ================== */
      function clampAllToBounds(){
        const cp=p=>{p.x=CLAMP(p.x,6,W-6);p.y=CLAMP(p.y,12,H-12)};
        cp(state.p1);cp(state.p2);
        state.items.forEach(it=>{it.x=CLAMP(it.x,10,W-10);it.y=CLAMP(it.y,20,H-40)});
        state.crabs.forEach(c=>{c.x=CLAMP(c.x,12,W-12);c.y=CLAMP(c.y,28,H-40)});
      }

      function reset(){
        state.time=30;state.tAccum=0;state.spawnTick=0;state.over=false;state.running=false;
        state.p1.score=0;state.p2.score=0;
        state.p1.x=W*.3;state.p1.y=H*.6;state.p2.x=W*.7;state.p2.y=H*.6;
        state.p1.shield=0;state.p1.turbo=0;state.p2.shield=0;state.p2.turbo=0;
        state.items=[];state.crabs=[];
        for(let i=0;i<8;i++) spawnCollectible();
        for(let i=0;i<4;i++) spawnCrab();
        for(let i=0;i<2;i++) spawnPowerUp();
        updateHud(); renderLeaderboard();
      }

      function spawnCrab(){
        const side=Math.random()<.5?0:W;
        const ramp=1+CRAB_RAMP*(state.time/30);
        const baseV=(CRAB_BASE+Math.random()*CRAB_RANGE)*ramp*.85;
        state.crabs.push({x:side,y:RNG(28,H-40),s:8,vx:side===0?baseV:-baseV});
      }
      function spawnCollectible(){
        const r=Math.random(); let type='heart',val=1;
        if(r>0.85&&r<=0.95){type='margarita';val=3}
        else if(r>0.95){type='ring';val=7}
        else if(r>0.65){type='champagne';val=2}
        state.items.push({kind:'collect',type,val,x:RNG(10,W-10),y:RNG(20,H-40)});
      }
      function spawnPowerUp(){
        const r = Math.random();
        const type = r > 0.8 ? 'time' : r > 0.55 ? 'shield' : r > 0.3 ? 'speed' : 'golden';
        state.items.push({kind:'power',type,x:RNG(10,W-10),y:RNG(20,H-40)});
      }

      function movePlayers(dt){
        const s1 = P_SPEED * (1 + (state.p1.turbo>0?0.8:0));
        const s2 = P_SPEED * (1 + (state.p2.turbo>0?0.8:0));
        const step = dt*0.06;

        if(keys['ArrowLeft'])  state.p1.x -= s1*step;
        if(keys['ArrowRight']) state.p1.x += s1*step;
        if(keys['ArrowUp'])    state.p1.y -= s1*step;
        if(keys['ArrowDown'])  state.p1.y += s1*step;

        if(players===2){
          if(keys['KeyA']) state.p2.x -= s2*step;
          if(keys['KeyD']) state.p2.x += s2*step;
          if(keys['KeyW']) state.p2.y -= s2*step;
          if(keys['KeyS']) state.p2.y += s2*step;
        }

        clampAllToBounds();
      }

      function hit(a,b,rad=7){ const dx=a.x-b.x, dy=a.y-b.y; return (dx*dx+dy*dy) < (rad*rad); }

      function handlePower(p, type){
        if(type==='time'){ state.time = Math.min(60, state.time+5); sPower(); }
        else if(type==='shield'){ p.shield = Math.max(p.shield, POWER_DUR); sPower(); }
        else if(type==='speed'){ p.turbo = Math.max(p.turbo, POWER_DUR); sPower(); }
        else if(type==='golden'){ p.score += 5; sPower(); }
        updateHud();
      }

      function update(dt){
        state.tAccum += dt;
        if(state.tAccum >= 1000){
          state.tAccum -= 1000;
          if(state.running && !state.over){
            state.time = Math.max(0, state.time - 1);
            if(state.p1.shield>0) state.p1.shield--;
            if(state.p2.shield>0) state.p2.shield--;
            if(state.p1.turbo>0) state.p1.turbo--;
            if(state.p2.turbo>0) state.p2.turbo--;
            if(state.time === 0){ endGame(); }
            updateHud();
          }
        }

        state.spawnTick += dt;
        const spawnEvery = 400;
        while(state.spawnTick >= spawnEvery){
          state.spawnTick -= spawnEvery;
          if(Math.random()<TICK_SPAWN_COLLECT) spawnCollectible();
          if(Math.random()<TICK_SPAWN_CRAB) spawnCrab();
          if(Math.random()<TICK_SPAWN_POWER) spawnPowerUp();
        }

        state.crabs.forEach(c=>{
          c.x += c.vx;
          c.vx *= CRAB_DRAG * CRAB_FRAME_MULT;
          c.vx = CLAMP(c.vx, -CRAB_MAX_VX, CRAB_MAX_VX);
          if(c.x < 10 || c.x > W-10){ c.vx *= -1; }
        });

        movePlayers(dt);

        for(let i=state.items.length-1;i>=0;i--){
          const it = state.items[i];
          if(hit(state.p1,it)){
            if(it.kind==='collect'){ state.p1.score += it.val; sCollect(); }
            else handlePower(state.p1,it.type);
            state.items.splice(i,1); continue;
          }
          if(players===2 && hit(state.p2,it)){
            if(it.kind==='collect'){ state.p2.score += it.val; sCollect(); }
            else handlePower(state.p2,it.type);
            state.items.splice(i,1); continue;
          }
        }

        for(const c of state.crabs){
          if(hit(state.p1,c)){
            if(state.p1.shield<=0){ state.p1.score = Math.max(0, state.p1.score-1); sHit(); }
          }
          if(players===2 && hit(state.p2,c)){
            if(state.p2.shield<=0){ state.p2.score = Math.max(0, state.p2.score-1); sHit(); }
          }
        }
      }

      function draw(){
        // sky + ground
        ctx.fillStyle = '#9fd8ff'; ctx.fillRect(0,0,W,H);
        ctx.fillStyle = '#87c66b'; ctx.fillRect(0,H-18,W,18);

        // items
        state.items.forEach(it=>{
          if(it.kind==='power'){
            if(it.type==='golden'){
              drawSpriteCentered(it.x, it.y, SPR.heartGold, ITEM_SCALE-1);
            }else if(it.type==='time'){
              drawSpriteCentered(it.x, it.y, SPR.ring, ITEM_SCALE-2);
            }else if(it.type==='shield'){
              const shield = {pal:{r:'#ffffff',s:'#e0e0e0'}, px: SPR.heart.px};
              drawSpriteCentered(it.x, it.y, shield, ITEM_SCALE-1);
            }else if(it.type==='speed'){
              drawSpriteCentered(it.x, it.y, SPR.champagne, ITEM_SCALE-1);
            }
          } else {
            if(it.type==='heart'){
              drawSpriteCentered(it.x, it.y, SPR.heart, ITEM_SCALE-1);
            }else if(it.type==='champagne'){
              drawSpriteCentered(it.x, it.y, SPR.champagne, ITEM_SCALE-1);
            }else if(it.type==='margarita'){
              drawSpriteCentered(it.x, it.y, SPR.margarita, ITEM_SCALE-1);
            }else if(it.type==='ring'){
              drawSpriteCentered(it.x, it.y, SPR.ring, ITEM_SCALE-2);
            }
          }
        });

        // crabs
        state.crabs.forEach(c=>{ drawSpriteCentered(c.x, c.y, SPR.crab, ITEM_SCALE-1); });

        // players
        drawSpriteCentered(state.p1.x, state.p1.y, SPR.p1, ITEM_SCALE);
        if(state.p1.shield>0){
          ctx.strokeStyle='#ffffff'; ctx.lineWidth=1;
          ctx.strokeRect(state.p1.x-((SPR.p1.px[0].length*ITEM_SCALE)/2+2),
                         state.p1.y-((SPR.p1.px.length*ITEM_SCALE)/2+2),
                         SPR.p1.px[0].length*ITEM_SCALE+4,
                         SPR.p1.px.length*ITEM_SCALE+4);
        }
        if(players===2){
          drawSpriteCentered(state.p2.x, state.p2.y, SPR.p2, ITEM_SCALE);
          if(state.p2.shield>0){
            ctx.strokeStyle='#ffffff'; ctx.lineWidth=1;
            ctx.strokeRect(state.p2.x-((SPR.p2.px[0].length*ITEM_SCALE)/2+2),
                           state.p2.y-((SPR.p2.px.length*ITEM_SCALE)/2+2),
                           SPR.p2.px[0].length*ITEM_SCALE+4,
                           SPR.p2.px.length*ITEM_SCALE+4);
          }
        }
      }

      let rafId = null, lastTs = 0;
      function loop(ts){
        if(!state.running){ return; }
        const dt = lastTs ? (ts - lastTs) : 16;
        lastTs = ts;
        update(dt);
        draw();
        rafId = requestAnimationFrame(loop);
      }

      function updateHud(){
        const total = state.p1.score + state.p2.score;
        state.best = Math.max(state.best, total);
        hud.textContent = `P1 Score: ${state.p1.score} | P2 Score: ${state.p2.score} | Time: ${state.time}s | Best: ${state.best}`;
      }

      function renderLeaderboard(){
        const list = (state.board||[]).slice(0,10);
        lbRows.innerHTML = list.length
          ? list.map((e,i)=>`<div class="lb-row"><span>${i+1}. ${e.initials}</span><span>${e.score}</span></div>`).join('')
          : '<div class="lb-row">No scores yet ‚Äî be the first!</div>';
      }

      function endGame(){
        state.over = true;
        state.running = false;
        cancelAnimationFrame(rafId);
        finalScores.textContent = `Final: P1 ${state.p1.score} ‚Äî P2 ${state.p2.score}`;
        endOverlay.classList.add('show');
      }

      // --- Touch joysticks ---
      function wireJoystick(padEl, baseEl, knobEl, mapping){
        const DEAD = 10, MAX = 42; let activeId = null;
        const reset = ()=>{
          knobEl.style.left = baseEl.style.left = '';
          knobEl.style.top  = baseEl.style.top  = '';
          ['up','down','left','right'].forEach(dir=> keys[mapping[dir]] = false);
        };
        padEl.addEventListener('pointerdown', (e)=>{
          activeId = e.pointerId; padEl.setPointerCapture(activeId);
          const r = padEl.getBoundingClientRect();
          const x = e.clientX - r.left, y = e.clientY - r.top;
          baseEl.style.left = (x-50)+'px'; baseEl.style.bottom = '12px';
          knobEl.style.left = x+'px'; knobEl.style.top  = y+'px';
        });
        padEl.addEventListener('pointermove', (e)=>{
          if(e.pointerId !== activeId) return;
          const r = padEl.getBoundingClientRect();
          const x = e.clientX - r.left, y = e.clientY - r.top;
          const baseRect = baseEl.getBoundingClientRect();
          const cx = baseRect.left - r.left + baseRect.width/2;
          const cy = baseRect.top  - r.top  + baseRect.height/2;
          let dx = x - cx, dy = y - cy;
          const dist = Math.hypot(dx, dy);
          const MAX = 42; if(dist > MAX){ dx *= MAX/dist; dy *= MAX/dist; }
          knobEl.style.left = (cx + dx) + 'px'; knobEl.style.top  = (cy + dy) + 'px';
          const left = dx < -DEAD, right = dx > DEAD, up = dy < -DEAD, down = dy > DEAD;
          keys[mapping.left]=left; keys[mapping.right]=right; keys[mapping.up]=up; keys[mapping.down]=down;
          e.preventDefault();
        }, {passive:false});
        const end = (e)=>{ if(e.pointerId !== activeId) return; reset(); padEl.releasePointerCapture(activeId); activeId = null; };
        padEl.addEventListener('pointerup', end); padEl.addEventListener('pointercancel', end);
      }
      wireJoystick(tp1, joyBase1, joyKnob1, {up:'ArrowUp',down:'ArrowDown',left:'ArrowLeft',right:'ArrowRight'});
      wireJoystick(tp2, joyBase2, joyKnob2, {up:'KeyW',down:'KeyS',left:'KeyA',right:'KeyD'});

      function togglePads(){ tp1.classList.remove('disabled'); tp2.classList.toggle('disabled', players!==2); }

      // Public controls for inline handlers
      window.__toggleMute = function __toggleMute(){
        muted = !muted;
        const btn = document.getElementById('muteBtn');
        btn.setAttribute('aria-pressed', String(muted));
        btn.textContent = muted ? 'üîá Sound Off' : 'üîà Sound On';
      };

      window.__doStart = function __doStart(){
        players = +(playersSelStart.value || playersSel.value);
        difficulty = +(diffSelStart.value || diffSel.value);
        playersSel.value = String(players);
        diffSel.value = String(difficulty);
        applyDifficulty();
        togglePads();

        startOverlay.classList.remove('show');
        endOverlay.classList.remove('show');

        reset();
        state.running = true;
        state.over = false;
        lastTs = 0;
        cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(loop);
      };

      // Wire buttons
      document.getElementById('startBtn').addEventListener('click', ()=>window.__doStart());
      pauseBtn.addEventListener('click', ()=>{
        if(state.over) return;
        if(state.running){
          state.running = false;
          cancelAnimationFrame(rafId);
          startOverlay.classList.add('show');
        }else{
          startOverlay.classList.remove('show');
          state.running = true;
          lastTs = 0;
          rafId = requestAnimationFrame(loop);
        }
      });

      // Save score
      saveScoreBtn.addEventListener('click', ()=>{
        const initials = (initialsInput.value || 'YOU').toUpperCase().slice(0,3);
        const total = state.p1.score + state.p2.score;
        const board = Array.isArray(state.board) ? state.board : [];
        board.push({initials, score: total, ts: Date.now()});
        board.sort((a,b)=>b.score-a.score);
        state.board = board;
        localStorage.setItem(STORAGE_LB, JSON.stringify(board));
        localStorage.setItem(STORAGE_BEST, String(Math.max(state.best, total)));
        renderLeaderboard();
      });

      window.addEventListener('resize', setAspectForScreen);
      setAspectForScreen();
      renderLeaderboard();
      updateHud();
      togglePads();
    })();
  </script>
</body>
</html>
